// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. 사용자 (Users)
// ==========================================
model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String?  @map("password_hash") // 명세서: password_hash
  name         String
  characterImage String? @map("character_image_url")
  points       Int      @default(1000)
  
  // 소셜 로그인 지원을 위해 유지 (명세서 외 추가 필드)
  nickname     String?  @unique
  kakaoId      String?  @unique @map("kakao_id")
  googleId     String?  @unique @map("google_id")
  refreshToken String?  @map("refresh_token")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  profiles         UserProfile[]
  teamMemberships  TeamMember[]
  joinRequests     TeamJoinRequest[]
  managedTournaments Tournament[]
  matchLineups     MatchLineup[]
  tactics          Tactic[]
  predictions      Prediction[]

  @@map("users") // 실제 DB 테이블명: users
}

// ==========================================
// 2. 사용자 프로필 (User_Profiles) - 종목별
// ==========================================
model UserProfile {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  sportType     String   @map("sport_type") // 'lol', 'soccer', 'basketball', 'futsal'
  position      String?
  tier          String?  // LoL 전용
  champions     String?  // LoL 전용 (Text)
  preferredFoot String?  @map("preferred_foot") // Soccer/Futsal
  height        String?  // Basketball
  introduction  String?  @db.Text
  
  createdAt     DateTime @default(now()) @map("created_at")

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, sportType])
  @@map("user_profiles")
}

// ==========================================
// 3. 팀 (Teams)
// ==========================================
model Team {
  id                   Int      @id @default(autoincrement())
  name                 String
  sport                String   // 'LoL', 'Soccer' (표기용)
  sportType            String   @map("sport_type") // 'lol', 'soccer' (로직용)
  inviteCode           String   @unique @map("invite_code")
  description          String?  @db.Text
  wins                 Int      @default(0)
  losses               Int      @default(0)
  matchCount           Int      @default(0) @map("match_count")
  representativeTacticId Int?   @map("representative_tactic_id")

  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  members              TeamMember[]
  joinRequests         TeamJoinRequest[]
  tournamentTeams      TournamentTeam[]
  wonTournaments       Tournament[] // 우승한 대회들
  
  homeMatches          Match[] @relation("TeamA")
  awayMatches          Match[] @relation("TeamB")
  wonMatches           Match[] @relation("WinnerTeam")
  
  tactics              Tactic[]
  predictedIn          Prediction[]
  lineups              MatchLineup[]

  @@map("teams")
}

// ==========================================
// 4. 팀 멤버 (Team_Members)
// ==========================================
model TeamMember {
  id        Int      @id @default(autoincrement())
  teamId    Int      @map("team_id")
  userId    Int      @map("user_id")
  role      String   // 'leader', 'member'
  position  String?
  joinedAt  DateTime @default(now()) @map("joined_at")

  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

// ==========================================
// 5. 팀 가입 신청 (Team_Join_Requests) [NEW]
// ==========================================
model TeamJoinRequest {
  id          Int       @id @default(autoincrement())
  teamId      Int       @map("team_id")
  userId      Int       @map("user_id")
  position    String?
  status      String    @default("pending") // 'pending', 'approved', 'rejected'
  appliedAt   DateTime  @default(now()) @map("applied_at")
  processedAt DateTime? @map("processed_at")

  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_join_requests")
}

// ==========================================
// 6. 대회 (Tournaments)
// ==========================================
model Tournament {
  id          Int       @id @default(autoincrement())
  name        String
  sport       String    // 'LoL', 'Soccer' (표기용)
  sportType   String    @default("lol") @map("sport_type") // 'lol', 'soccer' (로직용)
  status      String    // 'UPCOMING', 'ONGOING', 'ENDED'
  isPrivate   Boolean   @default(false) @map("is_private")
  inviteCode  String?   @map("invite_code")
  description String?   @db.Text
  managerId   Int?      @map("manager_id")
  winnerId    Int?      @map("winner_id")
  startDate   DateTime? @db.Date @map("start_date")
  endDate     DateTime? @db.Date @map("end_date")
  
  // 기존 로직 호환을 위해 유지 (명세서에는 없지만 필요시 사용)
  format       String   @default("TOURNAMENT") // "TOURNAMENT", "LEAGUE", "HYBRID"
  playoffTeams Int?     @map("playoff_teams")  // 하이브리드 시 본선 진출 팀 수 (예: 4)
  
  // ⭐ 대진표 생성 방식
  bracketGeneration String? @map("bracket_generation") // 'random' | 'manual' 

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")

  manager     User?     @relation(fields: [managerId], references: [id])
  winner      Team?     @relation(fields: [winnerId], references: [id])
  
  participatingTeams TournamentTeam[]
  matches            Match[]

  @@map("tournaments")
}

// ==========================================
// 7. 대회 참가 팀 (Tournament_Teams) [NEW]
// ==========================================
model TournamentTeam {
  id           Int      @id @default(autoincrement())
  tournamentId Int      @map("tournament_id")
  teamId       Int      @map("team_id")
  joinedAt     DateTime @default(now()) @map("joined_at")

  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  team         Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, teamId])
  @@map("tournament_teams")
}

// ==========================================
// 8. 경기 (Matches)
// ==========================================
model Match {
  id            Int       @id @default(autoincrement())
  tournamentId  Int       @map("tournament_id")
  roundName     String?   @map("round_name") // '8강', '준결승'
  
  teamAId       Int?      @map("team_a_id")
  teamBId       Int?      @map("team_b_id")
  teamAScore    Int?      @map("team_a_score")
  teamBScore    Int?      @map("team_b_score")
  winnerTeamId  Int?      @map("winner_team_id")
  
  status        String    // 'UPCOMING', 'ONGOING', 'DONE'
  matchDate     DateTime? @map("match_date")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  tournament    Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  teamA         Team?      @relation("TeamA", fields: [teamAId], references: [id])
  teamB         Team?      @relation("TeamB", fields: [teamBId], references: [id])
  winnerTeam    Team?      @relation("WinnerTeam", fields: [winnerTeamId], references: [id])

  stage        String   @default("MAIN") // "LEAGUE", "TOURNAMENT", "MAIN"
  lineups       MatchLineup[]
  predictions   Prediction[]
  stats         PredictionStat?

  @@map("matches")
}

// ==========================================
// 9. 경기 라인업 (Match_Lineups) [NEW]
// ==========================================
model MatchLineup {
  id        Int      @id @default(autoincrement())
  matchId   Int      @map("match_id")
  teamId    Int?     @map("team_id")
  userId    Int?     @map("user_id")
  position  String
  champion  String?  // LoL 전용
  createdAt DateTime @default(now()) @map("created_at")

  match     Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team      Team?    @relation(fields: [teamId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@map("match_lineups")
}

// ==========================================
// 10. 전술 (Tactics)
// ==========================================
model Tactic {
  id        Int      @id @default(autoincrement())
  creatorId Int?     @map("creator_id") // 명세서: creator_id
  teamId    Int?     @map("team_id")
  name      String
  boardType String   @map("board_type") // 'soccer', 'lol'
  type      String?  // 'formation', 'strategy'
  isPublic  Boolean  @default(false) @map("is_public")
  positions Json     // JSONB
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  creator   User?    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  team      Team?    @relation(fields: [teamId], references: [id])

  @@map("tactics")
}

// ==========================================
// 11. 승부예측 (Predictions)
// ==========================================
model Prediction {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  matchId         Int      @map("match_id")
  predictedTeamId Int      @map("predicted_team_id")
  betAmount       Int      @map("bet_amount")
  odds            Decimal? @db.Decimal(5, 2)
  status          String?  @default("pending") // 'pending', 'won', 'lost'
  payout          Int?
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  match           Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  predictedTeam   Team     @relation(fields: [predictedTeamId], references: [id])

  @@unique([userId, matchId])
  @@map("predictions")
}

// ==========================================
// 12. 예측 통계 (Prediction_Stats) [NEW]
// ==========================================
model PredictionStat {
  id              Int      @id @default(autoincrement())
  matchId         Int      @unique @map("match_id")
  totalVotes      Int      @default(0) @map("total_votes")
  totalPoints     Int      @default(0) @map("total_points")
  teamAPercentage Decimal? @default(0) @map("team_a_percentage") @db.Decimal(5, 2)
  teamBPercentage Decimal? @default(0) @map("team_b_percentage") @db.Decimal(5, 2)
  
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  match           Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@map("prediction_stats")
}